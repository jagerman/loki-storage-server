From: Jason Rhinelander <jason@imaginary.ca>
Date: Tue, 16 Jul 2019 16:08:10 -0300
Subject: Devendor loki-storage-server

---
 httpserver/CMakeLists.txt | 17 ++++++-----------
 storage/CMakeLists.txt    |  4 ++--
 2 files changed, 8 insertions(+), 13 deletions(-)

diff --git a/httpserver/CMakeLists.txt b/httpserver/CMakeLists.txt
index 48ff679..2706529 100644
--- a/httpserver/CMakeLists.txt
+++ b/httpserver/CMakeLists.txt
@@ -26,8 +26,6 @@ loki_add_subdirectory(../storage storage)
 loki_add_subdirectory(../utils utils)
 loki_add_subdirectory(../pow pow)
 loki_add_subdirectory(../crypto crypto)
-set(BUILD_SHARED_LIBS OFF CACHE BOOL "disable shared libraries") # Tells loki-mq to do a static build
-loki_add_subdirectory(../vendors/loki-mq loki-mq)
 find_package(OpenSSL REQUIRED)
 
 find_package(Boost
@@ -45,7 +43,6 @@ target_link_libraries(httpserver_lib PUBLIC utils)
 target_link_libraries(httpserver_lib PUBLIC pow)
 target_link_libraries(httpserver_lib PUBLIC resolv)
 target_link_libraries(httpserver_lib PUBLIC crypto)
-target_link_libraries(httpserver_lib PUBLIC lokimq::lokimq)
 
 set_property(TARGET httpserver_lib PROPERTY CXX_STANDARD 14)
 
@@ -60,19 +57,17 @@ set_property(TARGET httpserver PROPERTY CXX_STANDARD 14)
 target_link_libraries(httpserver PRIVATE httpserver_lib)
 install(TARGETS httpserver DESTINATION bin)
 # Build Info
-execute_process(
-    COMMAND
-        git rev-parse --short HEAD
-    OUTPUT_VARIABLE
-        SHORT_HASH
-    OUTPUT_STRIP_TRAILING_WHITESPACE)
 string(TIMESTAMP BUILD_TIME UTC)
-message(STATUS "using git commit hash ${SHORT_HASH}")
 message(STATUS "using UTC build time ${BUILD_TIME}")
-target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_GIT_HASH_STRING="${SHORT_HASH}")
+target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_GIT_HASH_STRING="deb-${LOKISS_VERSION_TAG}")
 target_compile_definitions(httpserver PRIVATE -DSTORAGE_SERVER_BUILD_TIME="${BUILD_TIME}")
 
 find_package(PkgConfig QUIET)
+
+pkg_check_modules(LOKIMQ REQUIRED liblokimq>=1.0.0)
+target_link_libraries(httpserver PUBLIC ${LOKIMQ_LIBRARIES})
+target_include_directories(httpserver PUBLIC ${LOKIMQ_INCLUDE_DIRS})
+
 if(PKG_CONFIG_FOUND)
     pkg_check_modules(SYSTEMD libsystemd)
     # Default ENABLE_SYSTEMD to true if we found it
diff --git a/storage/CMakeLists.txt b/storage/CMakeLists.txt
index 694702e..a4e79d8 100644
--- a/storage/CMakeLists.txt
+++ b/storage/CMakeLists.txt
@@ -17,8 +17,8 @@ loki_add_subdirectory(../common common)
 target_link_libraries(storage PRIVATE common)
 loki_add_subdirectory(../utils utils)
 target_link_libraries(storage PRIVATE utils)
-loki_add_subdirectory(../vendors/sqlite sqlite)
-target_link_libraries(storage PRIVATE sqlite)
+find_library(SQLITE3_LIBRARY sqlite3)
+target_link_libraries(storage PRIVATE ${SQLITE3_LIBRARY})
 
 
 if(NOT Boost_FOUND)
